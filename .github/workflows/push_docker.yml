name: push_docker

on:
    workflow_run:
      workflows:
      - "build_docker"
      branches:
      - main
      - dev
      types: 
      - completed

jobs:
  push_docker:
    runs-on: ubuntu-22.04
    steps:
      - name: Download Docker image from workspace
        uses: actions/download-artifact@v4
        with:
          name: staking-indexer
          path: /tmp/
          run-id: ${{ github.event.workflow_run.id }}
          # automatically generated token
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image
        run: docker load -i /tmp/staking-indexer.tar

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image
        run: |
          docker tag staking-indexer:${{ github.sha }} ${{ secrets.DOCKERHUB_REGISTRY_ID }}/staking-indexer:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_REGISTRY_ID }}/staking-indexer:${{ github.sha }}
